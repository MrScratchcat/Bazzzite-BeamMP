#!/bin/bash

# Script to set up BeamMP Launcher in Arch distrobox
# This script checks for an existing Arch distrobox, creates one if needed,
# and builds BeamMP Launcher with all dependencies

set -e  # Exit on any error

DISTROBOX_NAME="arch"

echo "Checking for existing Arch distrobox..."

# Check if distrobox exists
if distrobox list | grep -q "^${DISTROBOX_NAME}"; then
    echo "Arch distrobox '${DISTROBOX_NAME}' already exists."
else
    echo "Creating new Arch distrobox '${DISTROBOX_NAME}'..."
    distrobox create --name "${DISTROBOX_NAME}" --image archlinux:latest
    echo "Arch distrobox created successfully."
fi

echo "Entering distrobox and building BeamMP Launcher..."

# Execute the build commands inside the distrobox
distrobox enter "${DISTROBOX_NAME}" -- bash -c "
    set -e
    echo 'Installing dependencies...'
    sudo pacman -Syu libnewt base-devel git curl zip unzip tar cmake ninja --noconfirm
    
    echo 'Cloning and setting up vcpkg...'
    if [ ! -d \"vcpkg\" ]; then
        git clone https://github.com/microsoft/vcpkg.git
    fi
    cd vcpkg
    ./bootstrap-vcpkg.sh --disableMetrics
    export VCPKG_ROOT=\"\$HOME/vcpkg\"
    export PATH=\"\$VCPKG_ROOT:\$PATH\"
    
    echo 'Cloning BeamMP Launcher...'
    cd \$HOME
    if [ ! -d \"BeamMP-Launcher\" ]; then
        git clone --recurse-submodules https://github.com/BeamMP/BeamMP-Launcher.git
    fi
    
    echo 'Building BeamMP Launcher...'
    cd BeamMP-Launcher
    cmake -DCMAKE_BUILD_TYPE=Release . -B bin -DCMAKE_TOOLCHAIN_FILE=\"\$HOME/vcpkg/scripts/buildsystems/vcpkg.cmake\" -DVCPKG_TARGET_TRIPLET=x64-linux
    cmake --build bin --parallel --config Release
    
    echo 'Build completed successfully!'
    echo 'To start BeamMP, run:'
    echo "To start BeamMP go to: ${HOME}/BeamMP-Launcher/bin/BeamMP-Launcher"
"
